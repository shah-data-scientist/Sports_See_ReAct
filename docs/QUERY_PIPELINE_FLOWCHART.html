<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sports_See ‚Äî Query Pipeline Decision Flowchart</title>
<style>
  :root {
    --bg: #0d1117;
    --card: #161b22;
    --border: #30363d;
    --text: #c9d1d9;
    --heading: #f0f6fc;
    --accent-blue: #58a6ff;
    --accent-green: #3fb950;
    --accent-orange: #d29922;
    --accent-red: #f85149;
    --accent-purple: #bc8cff;
    --accent-teal: #39d2c0;
    --accent-pink: #f778ba;
    --muted: #8b949e;
    --yes: #3fb950;
    --no: #f85149;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    padding: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
  .header {
    text-align: center;
    padding: 40px 20px 20px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, #161b22 0%, #0d1117 100%);
  }
  .header h1 { color: var(--heading); font-size: 2rem; margin-bottom: 8px; }
  .header p { color: var(--muted); font-size: 0.95rem; max-width: 700px; margin: 0 auto; }

  /* ‚îÄ‚îÄ‚îÄ Legend ‚îÄ‚îÄ‚îÄ */
  .legend {
    display: flex; flex-wrap: wrap; gap: 16px; justify-content: center;
    padding: 16px 20px; border-bottom: 1px solid var(--border);
    background: var(--card);
  }
  .legend-item {
    display: flex; align-items: center; gap: 6px; font-size: 0.82rem; color: var(--muted);
  }
  .legend-dot {
    width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ Tab navigation ‚îÄ‚îÄ‚îÄ */
  .tabs {
    display: flex; justify-content: center; gap: 4px;
    padding: 16px 20px 0; background: var(--bg);
    position: sticky; top: 0; z-index: 100;
    border-bottom: 1px solid var(--border);
  }
  .tab {
    padding: 10px 24px; cursor: pointer; border: 1px solid var(--border);
    border-bottom: none; border-radius: 8px 8px 0 0; background: var(--card);
    color: var(--muted); font-size: 0.9rem; transition: all 0.2s;
  }
  .tab:hover { color: var(--text); background: #1c2129; }
  .tab.active {
    color: var(--accent-blue); border-color: var(--accent-blue);
    border-bottom: 2px solid var(--bg); background: var(--bg);
    font-weight: 600;
  }

  /* ‚îÄ‚îÄ‚îÄ Panels ‚îÄ‚îÄ‚îÄ */
  .panel { display: none; padding: 30px 20px; max-width: 1200px; margin: 0 auto; }
  .panel.active { display: block; }

  /* ‚îÄ‚îÄ‚îÄ Flow container ‚îÄ‚îÄ‚îÄ */
  .flow {
    display: flex; flex-direction: column; align-items: center; gap: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ Nodes ‚îÄ‚îÄ‚îÄ */
  .node {
    position: relative; border-radius: 10px; padding: 16px 22px;
    max-width: 620px; width: 100%; text-align: center;
    border: 1.5px solid var(--border); transition: all 0.2s;
  }
  .node:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }

  .node-start {
    background: linear-gradient(135deg, #1a3a5c, #1a2a4a);
    border-color: var(--accent-blue);
  }
  .node-decision {
    background: var(--card);
    border-color: var(--accent-orange);
    border-style: dashed;
    clip-path: none;
    transform: none;
  }
  .node-decision::before {
    content: ''; position: absolute; top: -1px; right: -1px;
    width: 24px; height: 24px; background: var(--accent-orange);
    clip-path: polygon(0 0, 100% 0, 100% 100%);
    border-radius: 0 9px 0 0; opacity: 0.3;
  }
  .node-process {
    background: var(--card);
    border-color: var(--accent-blue);
  }
  .node-output {
    background: linear-gradient(135deg, #1a3a2a, #0d2818);
    border-color: var(--accent-green);
  }
  .node-fallback {
    background: linear-gradient(135deg, #3a1a1a, #2a0d0d);
    border-color: var(--accent-red);
  }
  .node-prompt {
    background: linear-gradient(135deg, #2a1a3a, #1a0d2a);
    border-color: var(--accent-purple);
  }

  .node-label {
    font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1px;
    margin-bottom: 6px; font-weight: 600;
  }
  .node-label.blue { color: var(--accent-blue); }
  .node-label.orange { color: var(--accent-orange); }
  .node-label.green { color: var(--accent-green); }
  .node-label.red { color: var(--accent-red); }
  .node-label.purple { color: var(--accent-purple); }
  .node-label.teal { color: var(--accent-teal); }
  .node-label.pink { color: var(--accent-pink); }

  .node-title { font-size: 1.05rem; font-weight: 600; color: var(--heading); margin-bottom: 4px; }
  .node-detail { font-size: 0.85rem; color: var(--muted); }
  .node-detail code {
    background: rgba(110,118,129,0.15); padding: 1px 5px; border-radius: 3px;
    font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 0.82rem;
    color: var(--accent-teal);
  }

  /* ‚îÄ‚îÄ‚îÄ Arrows ‚îÄ‚îÄ‚îÄ */
  .arrow {
    display: flex; flex-direction: column; align-items: center; gap: 0;
    position: relative; min-height: 36px;
  }
  .arrow-line {
    width: 2px; height: 20px; background: var(--border);
  }
  .arrow-head {
    width: 0; height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 8px solid var(--border);
  }
  .arrow-label {
    font-size: 0.75rem; color: var(--muted);
    background: var(--bg); padding: 1px 8px; border-radius: 10px;
    border: 1px solid var(--border); margin: 2px 0;
    white-space: nowrap;
  }
  .arrow-label.yes { color: var(--yes); border-color: var(--yes); }
  .arrow-label.no { color: var(--no); border-color: var(--no); }

  /* ‚îÄ‚îÄ‚îÄ Branch (side-by-side paths) ‚îÄ‚îÄ‚îÄ */
  .branch {
    display: flex; gap: 20px; width: 100%; max-width: 1100px;
    justify-content: center; align-items: flex-start;
  }
  .branch-path {
    flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0;
    max-width: 350px;
  }
  .branch-label {
    font-size: 0.78rem; font-weight: 600; padding: 4px 14px;
    border-radius: 12px; margin-bottom: 8px; text-align: center;
  }
  .branch-label.stat { background: rgba(88,166,255,0.15); color: var(--accent-blue); border: 1px solid rgba(88,166,255,0.3); }
  .branch-label.context { background: rgba(188,140,255,0.15); color: var(--accent-purple); border: 1px solid rgba(188,140,255,0.3); }
  .branch-label.hybrid { background: rgba(57,210,192,0.15); color: var(--accent-teal); border: 1px solid rgba(57,210,192,0.3); }

  /* ‚îÄ‚îÄ‚îÄ Info boxes ‚îÄ‚îÄ‚îÄ */
  .info-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px; margin-top: 12px;
  }
  .info-box {
    background: var(--card); border: 1px solid var(--border); border-radius: 8px;
    padding: 16px; font-size: 0.85rem;
  }
  .info-box h4 { color: var(--heading); margin-bottom: 8px; font-size: 0.95rem; }
  .info-box ul { padding-left: 18px; }
  .info-box li { margin-bottom: 4px; color: var(--muted); }
  .info-box li code { color: var(--accent-teal); background: rgba(110,118,129,0.15); padding: 1px 4px; border-radius: 3px; font-size: 0.82rem; }


  /* ‚îÄ‚îÄ‚îÄ Mapping table ‚îÄ‚îÄ‚îÄ */
  .map-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  .map-table th, .map-table td {
    padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
  }
  .map-table th { color: var(--heading); font-weight: 600; background: rgba(22,27,34,0.8); }
  .map-table td { color: var(--muted); }
  .map-table tr:hover td { background: rgba(88,166,255,0.05); }

  .tag {
    display: inline-block; font-size: 0.75rem; padding: 2px 8px;
    border-radius: 10px; font-weight: 500;
  }
  .tag-sql { background: rgba(88,166,255,0.15); color: var(--accent-blue); }
  .tag-vector { background: rgba(188,140,255,0.15); color: var(--accent-purple); }
  .tag-hybrid { background: rgba(57,210,192,0.15); color: var(--accent-teal); }
  .tag-greeting { background: rgba(63,185,80,0.15); color: var(--accent-green); }
  .tag-fallback { background: rgba(248,81,73,0.15); color: var(--accent-red); }

  /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 800px) {
    .branch { flex-direction: column; align-items: center; }
    .branch-path { max-width: 100%; }
    .info-grid { grid-template-columns: 1fr; }
  }

  /* ‚îÄ‚îÄ‚îÄ Highlight on hover ‚îÄ‚îÄ‚îÄ */
  .highlight-stat:hover { border-color: var(--accent-blue) !important; }
  .highlight-ctx:hover { border-color: var(--accent-purple) !important; }
  .highlight-hyb:hover { border-color: var(--accent-teal) !important; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="header">
  <h1>Sports_See Query Pipeline</h1>
  <p>Every decision, mapping, and transformation from user input to final response.
     Hover over nodes for emphasis. Click tabs to explore each layer.</p>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEGEND ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:var(--accent-blue)"></div> Process / SQL Path</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--accent-orange)"></div> Decision Point</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--accent-green)"></div> Output / Early Return</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--accent-purple)"></div> Prompt / Vector Path</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--accent-teal)"></div> Hybrid Path</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--accent-red)"></div> Fallback / Error</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--accent-pink)"></div> Biographical</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('overview')">Full Pipeline</div>
  <div class="tab" onclick="switchTab('classifier')">Classifier Logic</div>
  <div class="tab" onclick="switchTab('routing')">Routing &amp; Data</div>
  <div class="tab" onclick="switchTab('prompts')">Prompt Selection</div>
  <div class="tab" onclick="switchTab('expansion')">Query Expansion</div>
  <div class="tab" onclick="switchTab('datapipeline')">Data Pipeline</div>
  <div class="tab" onclick="switchTab('mappings')">All Mappings</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 1: FULL PIPELINE OVERVIEW
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="panel-overview" class="panel active">
  <div class="flow">

    <!-- 1. Input -->
    <div class="node node-start">
      <div class="node-label blue">ENTRY POINT</div>
      <div class="node-title">User Query Received</div>
      <div class="node-detail"><code>POST /chat</code> &rarr; <code>ChatService.chat(request)</code></div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 2. Sanitize -->
    <div class="node node-process">
      <div class="node-label blue">STEP 1</div>
      <div class="node-title">Sanitize Query</div>
      <div class="node-detail"><code>sanitize_query(request.query)</code> &mdash; strips injection, validates length</div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 3. Greeting check -->
    <div class="node node-decision">
      <div class="node-label orange">DECISION 1 &mdash; STRICT DETECTION</div>
      <div class="node-title">Is it a PURE standalone greeting?</div>
      <div class="node-detail"><code>_is_greeting(query)</code> &mdash; Only standalone greetings with NO other content.<br><br>
      <strong>‚úÖ Pure greetings (early exit)</strong>:<br>
      &bull; "hi", "hello", "hey", "thanks", "goodbye", "bye"<br>
      &bull; "good morning", "how are you", "what's up"<br>
      &bull; "hi there", "hello everyone" (greeting + simple address)<br><br>
      <strong>‚ùå NOT pure (proceed to classification)</strong>:<br>
      &bull; "hi, who are the top 5 scorers?" (comma + question)<br>
      &bull; "hello, can you help me?" (action request)<br>
      &bull; "hey there, what about LeBron?" (basketball keywords)<br>
      &bull; "thanks for the stats" (refers to previous interaction)<br><br>
      <strong>Exclusions</strong>: comma, "?", basketball/sports keywords, action requests ("can you", "show me"), numbers, >6 words</div>
    </div>

    <div class="arrow">
      <div class="arrow-label yes">YES (pure greeting) &rarr; early return</div>
      <div class="arrow-line" style="height:10px"></div>
    </div>

    <div class="node node-output" style="max-width:460px">
      <div class="node-label green">EARLY RETURN</div>
      <div class="node-title">Canned Greeting Response</div>
      <div class="node-detail">No RAG, no SQL, no LLM. Lookup in <code>greeting_responses</code> dict. Sources = []<br>
      Examples: "Hello! üëã I'm here to help...", "Goodbye! üëã Come back anytime..."</div>
    </div>

    <div class="arrow">
      <div class="arrow-label no">NO (mixed or real query) &darr; continue</div>
      <div class="arrow-line" style="height:10px"></div>
      <div class="arrow-head"></div>
    </div>

    <!-- 4. Conversation context -->
    <div class="node node-process">
      <div class="node-label blue">STEP 2</div>
      <div class="node-title">Build Conversation Context</div>
      <div class="node-detail">If <code>conversation_id</code> provided: load last 5 turns from <code>FeedbackRepository</code></div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 5. Follow-up detection -->
    <div class="node node-decision">
      <div class="node-label orange">DECISION 2</div>
      <div class="node-title">Is it a follow-up query?</div>
      <div class="node-detail"><code>_is_followup_query()</code> &mdash; pronouns ("his", "that player"), short (&le;4 words), phrases ("what about", "tell me more")</div>
    </div>

    <div class="arrow">
      <div class="arrow-label yes">YES &rarr; rewrite with LLM</div>
      <div class="arrow-line" style="height:10px"></div>
    </div>

    <div class="node node-process" style="max-width:500px; border-color:var(--accent-orange)">
      <div class="node-label orange">REWRITE</div>
      <div class="node-title">LLM Query Rewriting</div>
      <div class="node-detail"><code>_rewrite_followup_query()</code> &mdash; Gemini resolves pronouns/references into self-contained question.<br>"What about his assists?" &rarr; "What are LeBron James' assists per game?"</div>
    </div>

    <div class="arrow">
      <div class="arrow-label">effective_query set</div>
      <div class="arrow-line" style="height:10px"></div>
      <div class="arrow-head"></div>
    </div>

    <!-- 5.5. Query Expansion (BEFORE classification) -->
    <div class="node node-process" style="border-color:var(--accent-teal)">
      <div class="node-label teal">STEP 3A &mdash; PRE-PROCESSING</div>
      <div class="node-title">Query Expansion (before classification)</div>
      <div class="node-detail"><code>expand_smart_category(effective_query)</code><br>
      Adds synonyms, player nicknames, team expansions, stat expansions<br>
      Category-aware: noisy(1), conversational(5), simple(4), complex(2)<br>
      <em>(see "Query Expansion" tab for details)</em></div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 6. Classification (single call returns all metadata) -->
    <div class="node node-decision" style="border-color:var(--accent-purple)">
      <div class="node-label purple">DECISION 3 &mdash; CORE CLASSIFIER</div>
      <div class="node-title">ClassificationResult = classify(expanded_query)</div>
      <div class="node-detail">Single call returns <code>ClassificationResult</code> dataclass bundling:<br>
      &bull; <code>query_type</code>: STATISTICAL, CONTEXTUAL, or HYBRID (via weighted scoring)<br>
      &bull; <code>is_biographical</code>: player/team info (triggers SQL rewrite)<br>
      &bull; <code>complexity_k</code>: adaptive retrieval depth (3, 5, 7, or 9)<br>
      &bull; <code>query_category</code>: noisy, conversational, simple, or complex<br><br>
      <strong>Note</strong>: Pure greetings never reach this step (handled in Decision 1)<br>
      <em>(see "Classifier Logic" tab for full breakdown)</em></div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 9. Routing split -->
    <div class="node node-process" style="border-color:var(--accent-teal)">
      <div class="node-label teal">ROUTING</div>
      <div class="node-title">Route to Data Sources</div>
      <div class="node-detail"><em>(see "Routing &amp; Data" tab for full breakdown)</em></div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 10. Prompt selection -->
    <div class="node node-prompt">
      <div class="node-label purple">STEP 4</div>
      <div class="node-title">Select Prompt Template</div>
      <div class="node-detail">4 templates: SQL_ONLY, HYBRID, CONTEXTUAL, SYSTEM (fallback)<br><em>(see "Prompt Selection" tab)</em></div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 11. LLM call -->
    <div class="node node-process">
      <div class="node-label blue">STEP 5</div>
      <div class="node-title">Generate LLM Response</div>
      <div class="node-detail">Gemini <code>generate_content()</code> with <code>retry_with_exponential_backoff()</code> (429 handling, 3 retries, 2s&rarr;30s)</div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 12. Smart fallback -->
    <div class="node node-decision" style="border-color:var(--accent-red)">
      <div class="node-label red">DECISION 5 &mdash; SMART FALLBACK</div>
      <div class="node-title">Did SQL succeed but LLM says "cannot find"?</div>
      <div class="node-detail">If <code>"cannot find" in answer</code> AND SQL was successful &rarr; retry entire response with vector search context</div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 13. Visualization -->
    <div class="node node-process" style="border-color:var(--accent-teal)">
      <div class="node-label teal">STEP 6</div>
      <div class="node-title">Generate Visualization (optional)</div>
      <div class="node-detail">For STATISTICAL/HYBRID with SQL data &rarr; <code>VisualizationService.generate_visualization()</code><br>Plotly chart (bar, line, scatter, etc.)</div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 14. Save + Return -->
    <div class="node node-output">
      <div class="node-label green">FINAL OUTPUT</div>
      <div class="node-title">ChatResponse</div>
      <div class="node-detail"><code>answer</code>, <code>sources[]</code>, <code>processing_time_ms</code>, <code>model</code>, <code>generated_sql</code>, <code>visualization</code></div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 2: CLASSIFIER LOGIC
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="panel-classifier" class="panel">
  <div class="flow">

    <div class="node node-start">
      <div class="node-label blue">INPUT</div>
      <div class="node-title">QueryClassifier.classify(query) &rarr; ClassificationResult</div>
      <div class="node-detail">6-step cascading waterfall &mdash; first match wins, no backtracking.<br>
      Returns <code>ClassificationResult(query_type, is_biographical, is_greeting, complexity_k)</code></div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- Phase 14 -->
    <div class="node node-decision">
      <div class="node-label orange">CHECK 1 of 6</div>
      <div class="node-title">Opinion / Subjective Quality?</div>
      <div class="node-detail">Patterns: "most exciting", "best player" (bare), "most fun", "coolest moment"<br>
      Catches subjective adjectives: <em>exciting, fun, dramatic, impressive, thrilling, boring, memorable, legendary, iconic, wild, crazy</em><br>
      Also catches bare superlatives without stat qualifier: "best player" (no "scorer/rebounder" after it)</div>
    </div>

    <div class="arrow">
      <div class="arrow-label yes">YES &rarr; CONTEXTUAL</div>
      <div class="arrow-line" style="height:6px"></div>
    </div>

    <div class="node node-output" style="max-width:350px">
      <div class="node-title"><span class="tag tag-vector">CONTEXTUAL</span></div>
      <div class="node-detail">Vector search for opinions &amp; discussions</div>
    </div>

    <div class="arrow">
      <div class="arrow-label no">NO &darr;</div>
      <div class="arrow-line" style="height:6px"></div>
      <div class="arrow-head"></div>
    </div>

    <!-- Phase 17 -->
    <div class="node node-decision" style="border-color:var(--accent-pink)">
      <div class="node-label pink">CHECK 2 of 6</div>
      <div class="node-title">Biographical Query?</div>
      <div class="node-detail"><code>_is_biographical()</code>: "Who is LeBron?", "Tell me about Kobe", "Info on the Warriors"<br>
      Always routes to HYBRID &mdash; fetches SQL stats + vector biographical context</div>
    </div>

    <div class="arrow">
      <div class="arrow-label yes">YES &rarr; HYBRID</div>
      <div class="arrow-line" style="height:6px"></div>
    </div>

    <div class="node node-output" style="max-width:350px; border-color:var(--accent-teal)">
      <div class="node-title"><span class="tag tag-hybrid">HYBRID</span></div>
      <div class="node-detail">SQL stats + vector biographical context</div>
    </div>

    <div class="arrow">
      <div class="arrow-label no">NO &darr;</div>
      <div class="arrow-line" style="height:6px"></div>
      <div class="arrow-head"></div>
    </div>

    <!-- Definitional -->
    <div class="node node-decision">
      <div class="node-label orange">CHECK 3 of 6</div>
      <div class="node-title">Definitional Query?</div>
      <div class="node-detail"><code>_is_definitional()</code>: "Define TS%", "What is a triple-double?", "What does efficiency mean?"<br>
      Overrides stat keywords &mdash; "Define fg%" is definitional, not statistical</div>
    </div>

    <div class="arrow">
      <div class="arrow-label yes">YES &rarr; CONTEXTUAL</div>
      <div class="arrow-line" style="height:6px"></div>
    </div>

    <div class="node node-output" style="max-width:350px">
      <div class="node-title"><span class="tag tag-vector">CONTEXTUAL</span></div>
      <div class="node-detail">Vector search for definitions &amp; glossary</div>
    </div>

    <div class="arrow">
      <div class="arrow-label no">NO &darr;</div>
      <div class="arrow-line" style="height:6px"></div>
      <div class="arrow-head"></div>
    </div>

    <!-- Glossary -->
    <div class="node node-decision">
      <div class="node-label orange">CHECK 4 of 6</div>
      <div class="node-title">Glossary Term (without stat intent)?</div>
      <div class="node-detail"><code>_has_glossary_term()</code>: 18 basketball terms (triple-double, pick-and-roll, zone defense, etc.)<br>
      <strong>Exception</strong>: if query has stat intent ("highest true shooting%") &rarr; skip, continue</div>
    </div>

    <div class="arrow">
      <div class="arrow-label yes">YES (no stat intent) &rarr; CONTEXTUAL</div>
      <div class="arrow-line" style="height:6px"></div>
      <div class="arrow-head"></div>
    </div>

    <!-- Weighted scoring -->
    <div class="node node-decision" style="border-color:var(--accent-blue)">
      <div class="node-label blue">CHECK 5 of 6 &mdash; WEIGHTED SCORING</div>
      <div class="node-title">Compute Weighted Scores (STAT vs CTX)</div>
      <div class="node-detail">
        <strong>13 STAT_GROUPS</strong> (weights 0.5-3.0): DB abbreviations (3.0), full stat words (3.0), superlatives (2.0), aggregations (2.0), comparisons (1.5), etc.<br>
        <strong>10 CTX_GROUPS</strong> (weights 1.0-3.0): why/how (3.0), opinions (2.5), subjective qualifiers (2.0), strategy (2.0), impact (2.0), etc.<br><br>
        Each group fires <strong>at most once</strong> (no double-counting)<br>
        <code>stat_score, stat_groups = _compute_weighted_score(query, STAT_GROUPS)</code><br>
        <code>ctx_score, ctx_groups = _compute_weighted_score(query, CTX_GROUPS)</code>
      </div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 3-Tier Hybrid Detection -->
    <div class="node node-decision" style="border-color:var(--accent-teal)">
      <div class="node-label teal">CHECK 6 of 6 &mdash; 3-TIER HYBRID DETECTION</div>
      <div class="node-title">Three-Level Hybrid Detection System</div>
      <div class="node-detail">
        <strong>Tier 1 ‚Äî Connector-based (structural)</strong>:<br>
        If connector detected ("and explain", "and why", "but why", etc.) AND stat_score &gt; 0 AND ctx_score &gt; 0 &rarr; <span class="tag tag-hybrid">HYBRID</span><br><br>
        <strong>Tier 2 ‚Äî Imbalance ratio (balanced strength)</strong>:<br>
        ratio = min(stat, ctx) / max(stat, ctx)<br>
        If both scores &ge; 1.5 AND ratio &ge; 0.4 &rarr; <span class="tag tag-hybrid">HYBRID</span><br><br>
        <strong>Tier 3 ‚Äî Fallback auto-promote (safety net)</strong>:<br>
        If stat_score &ge; 4.0 AND ctx_score &ge; 2.0 &rarr; <span class="tag tag-hybrid">HYBRID</span><br><br>
        <strong>Otherwise</strong>: highest weighted score wins<br>
        <strong>Tie or zero</strong>: <span class="tag tag-vector">CONTEXTUAL</span> (safe default)
      </div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- Complexity K calculation -->
    <div class="node node-process" style="border-color:var(--accent-teal)">
      <div class="node-label teal">ADAPTIVE K CALCULATION</div>
      <div class="node-title">Determine Retrieval Depth (complexity_k)</div>
      <div class="node-detail">
        <code>_estimate_question_complexity(query)</code> calculates complexity score (0-6+):<br><br>
        <strong>Indicators scored</strong>:<br>
        &bull; Simple patterns (+0): "how many", "who scored", short queries (&lt;5 words)<br>
        &bull; Moderate patterns (+1 each): "top", "compare", "most", "average", commas, "and"<br>
        &bull; Complex patterns (+2 each): "explain", "analyze", "impact", "why", "strategy"<br>
        &bull; Very complex: long queries (&gt;100 chars) or multiple "and"/"," connectors<br><br>
        <strong>K mapping</strong>:<br>
        Score ‚â§1 ‚Üí k=3 | Score 2-3 ‚Üí k=5 | Score 4-5 ‚Üí k=7 | Score ‚â•6 ‚Üí k=9
      </div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- Query category classification -->
    <div class="node node-process" style="border-color:var(--accent-orange)">
      <div class="node-label orange">QUERY CATEGORY CLASSIFICATION</div>
      <div class="node-title">Classify Query Quality (query_category)</div>
      <div class="node-detail">
        <code>_classify_category(query)</code> returns category for expansion strategy:<br><br>
        <strong>"noisy"</strong>: slang ("yo", "bruh"), typos, out-of-scope, security attacks, excessive punctuation<br>
        <strong>"conversational"</strong>: pronouns ("his", "that"), follow-up phrases ("what about", "and"), corrections<br>
        <strong>"complex"</strong>: synthesis terms ("analyze", "evaluate"), multi-part (commas/"and"), long (&gt;15 words)<br>
        <strong>"simple"</strong>: default for clear, well-formed queries
      </div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <div class="node node-output">
      <div class="node-label green">RESULT</div>
      <div class="node-title">ClassificationResult Returned</div>
      <div class="node-detail">
        <code>query_type</code>: <span class="tag tag-sql">STATISTICAL</span> or <span class="tag tag-vector">CONTEXTUAL</span> or <span class="tag tag-hybrid">HYBRID</span><br>
        <code>is_biographical</code>: True/False<br>
        <code>complexity_k</code>: 3/5/7/9 &bull; <code>query_category</code>: noisy/conversational/complex/simple<br><br>
        <strong>Note</strong>: Greetings are filtered in chat.py before classify() is called
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 3: ROUTING & DATA SOURCES
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="panel-routing" class="panel">
  <div class="flow">

    <div class="node node-start">
      <div class="node-label blue">INPUT</div>
      <div class="node-title">query_type + effective_query + adaptive_k</div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <div class="node node-decision">
      <div class="node-label orange">ROUTING DECISION</div>
      <div class="node-title">Which data sources to query?</div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- 3-way branch -->
    <div class="branch">

      <!-- STATISTICAL path -->
      <div class="branch-path">
        <div class="branch-label stat">STATISTICAL</div>

        <div class="node node-process highlight-stat" style="border-color:var(--accent-blue)">
          <div class="node-label blue">SQL PATH</div>
          <div class="node-title">NBAGSQLTool.query()</div>
          <div class="node-detail">
            If biographical &rarr; rewrite:<br>
            <code>"Who is LeBron?"</code> &rarr;<br>
            <code>"Show name, team, age, pts, reb, ast... for LeBron"</code>
          </div>
        </div>

        <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

        <div class="node node-decision" style="max-width:340px">
          <div class="node-label orange">SQL OK?</div>
          <div class="node-title">Results returned?</div>
        </div>

        <div class="arrow">
          <div class="arrow-label yes">YES</div>
          <div class="arrow-line" style="height:6px"></div>
        </div>

        <div class="node node-process highlight-stat" style="max-width:340px">
          <div class="node-title">Format SQL Results</div>
          <div class="node-detail"><code>_format_sql_results()</code><br>
          Scalar (COUNT/AVG/SUM) &rarr; "COUNT Result: N"<br>
          Single row &rarr; bullet points<br>
          Multi-row &rarr; numbered list (top 20)</div>
        </div>

        <div class="arrow">
          <div class="arrow-label no">FAIL/NO RESULTS</div>
          <div class="arrow-line" style="height:6px"></div>
        </div>

        <div class="node node-fallback" style="max-width:340px">
          <div class="node-label red">FALLBACK</div>
          <div class="node-title">Fall to Vector Search</div>
          <div class="node-detail"><code>enable_vector_fallback=True</code><br>SQL error or empty &rarr; use vector path instead</div>
        </div>
      </div>

      <!-- CONTEXTUAL path -->
      <div class="branch-path">
        <div class="branch-label context">CONTEXTUAL</div>

        <div class="node node-process highlight-ctx" style="border-color:var(--accent-purple)">
          <div class="node-label purple">VECTOR PATH</div>
          <div class="node-title">Vector Search Pipeline</div>
        </div>

        <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

        <div class="node node-process highlight-ctx" style="max-width:340px; border-color:var(--accent-purple)">
          <div class="node-title">1. Embed Query</div>
          <div class="node-detail"><code>EmbeddingService.embed_query(expanded_query)</code><br>
          Mistral embeddings &rarr; 1024-dim vector<br>
          <em>Note: Query already expanded before classification</em></div>
        </div>

        <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

        <div class="node node-process highlight-ctx" style="max-width:340px; border-color:var(--accent-purple)">
          <div class="node-label purple">SCORING</div>
          <div class="node-title">2. 3-Signal Hybrid Scoring</div>
          <div class="node-detail"><code>VectorStoreRepository.search()</code><br>
          <strong>Cosine (50%)</strong>: FAISS semantic similarity<br>
          <strong>BM25 (35%)</strong>: Exact keyword matching<br>
          <strong>Metadata (15%)</strong>: Reddit upvotes, engagement, NBA official<br>
          Score = cosine*0.5 + bm25*0.35 + meta*0.15</div>
        </div>

        <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

        <div class="node node-output" style="max-width:340px">
          <div class="node-title">Top-K Results</div>
          <div class="node-detail">k = adaptive (3, 5, 7, or 9)<br>Each: text, score, source, metadata</div>
        </div>
      </div>

      <!-- HYBRID path -->
      <div class="branch-path">
        <div class="branch-label hybrid">HYBRID</div>

        <div class="node node-process" style="border-color:var(--accent-teal); max-width:340px">
          <div class="node-label teal">DUAL RETRIEVAL</div>
          <div class="node-title">SQL + Vector in sequence</div>
          <div class="node-detail">Execute both data sources to get complete context</div>
        </div>

        <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

        <!-- Mini branch showing parallel processing -->
        <div style="display:flex; flex-direction:column; gap:8px; width:340px; max-width:100%">
          <div class="node node-process highlight-stat" style="border-color:var(--accent-blue); border-left-width:4px">
            <div class="node-label blue">BRANCH 1</div>
            <div class="node-title">SQL Tool Query</div>
            <div class="node-detail">Same as STATISTICAL path<br>
            Biographical rewrite applies<br>
            ‚Üí <code>sql_context</code></div>
          </div>

          <div class="arrow" style="min-height:12px">
            <div class="arrow-label">+</div>
          </div>

          <div class="node node-process highlight-ctx" style="border-color:var(--accent-purple); border-left-width:4px">
            <div class="node-label purple">BRANCH 2</div>
            <div class="node-title">Vector Search</div>
            <div class="node-detail">Same vector pipeline<br>
            Embedding + 3-signal scoring<br>
            ‚Üí <code>vector_context</code></div>
          </div>
        </div>

        <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

        <div class="node node-output" style="max-width:340px; border-color:var(--accent-teal)">
          <div class="node-title">Dual Context Merged</div>
          <div class="node-detail"><code>sql_context</code> + <code>vector_context</code><br>
          Both passed separately to HYBRID_PROMPT<br>
          LLM must synthesize both sources</div>
        </div>
      </div>

    </div><!-- end branch -->

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 4: PROMPT SELECTION
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="panel-prompts" class="panel">
  <div class="flow">

    <div class="node node-start">
      <div class="node-label blue">INPUT</div>
      <div class="node-title">query_type + sql_success + vector_context available?</div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <div class="node node-decision">
      <div class="node-label orange">PROMPT ROUTING</div>
      <div class="node-title">4 Prompt Templates</div>
      <div class="node-detail">Each prompt has different instructions for how the LLM should use the data</div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>
  </div>

  <div class="info-grid">

    <div class="info-box" style="border-left: 3px solid var(--accent-blue)">
      <h4><span class="tag tag-sql">SQL_ONLY_PROMPT</span></h4>
      <p style="margin-bottom:8px"><strong>When:</strong> STATISTICAL + SQL success</p>
      <ul>
        <li>Context variable: <code>{context}</code> = formatted SQL rows</li>
        <li>Instructions: "Tell the story with data", synthesize numbers</li>
        <li>"If data is shown above, present it confidently"</li>
        <li>Mandates: NO general knowledge, only provided data</li>
        <li>Citation: "Sources: Database Name" at the end</li>
      </ul>
    </div>

    <div class="info-box" style="border-left: 3px solid var(--accent-teal)">
      <h4><span class="tag tag-hybrid">HYBRID_PROMPT</span></h4>
      <p style="margin-bottom:8px"><strong>When:</strong> HYBRID + SQL success + vector context exists</p>
      <ul>
        <li>Two context variables: <code>{sql_context}</code> + <code>{vector_context}</code></li>
        <li>Uses <code>generate_response_hybrid()</code> (separate method)</li>
        <li>Instructions: "YOU MUST USE BOTH DATA SOURCES"</li>
        <li>"Weave together naturally", "FAILURE TO SYNTHESIZE IS UNACCEPTABLE"</li>
        <li>Stats answer WHAT, Context explains WHY</li>
      </ul>
    </div>

    <div class="info-box" style="border-left: 3px solid var(--accent-purple)">
      <h4><span class="tag tag-vector">CONTEXTUAL_PROMPT</span></h4>
      <p style="margin-bottom:8px"><strong>When:</strong> CONTEXTUAL + vector context exists</p>
      <ul>
        <li>Context variable: <code>{context}</code> = vector search results</li>
        <li>Enhanced for biographical queries</li>
        <li>"Synthesize, don't list" &mdash; weave opinions/facts into narrative</li>
        <li>Mandates: ONLY answer from provided context, FORBIDDEN general knowledge</li>
        <li>"If information is NOT in the context, say so"</li>
      </ul>
    </div>

    <div class="info-box" style="border-left: 3px solid var(--accent-red)">
      <h4><span class="tag tag-fallback">SYSTEM_PROMPT_TEMPLATE</span> (Fallback)</h4>
      <p style="margin-bottom:8px"><strong>When:</strong> None of the above match (e.g., SQL failed + no vector context)</p>
      <ul>
        <li>Context variable: <code>{context}</code> = combined sql + vector (or "No relevant information found.")</li>
        <li>Generic instructions: synthesize, add personality, remove inline citations</li>
        <li>Also used when SQL succeeded but vector is empty (HYBRID without vector)</li>
        <li>Last resort &mdash; catches edge cases</li>
      </ul>
    </div>

  </div>

  <div class="flow" style="margin-top: 30px">
    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <div class="node node-process">
      <div class="node-label blue">LLM CALL</div>
      <div class="node-title">Gemini generate_content()</div>
      <div class="node-detail">Temperature: <code>settings.temperature</code> | top_p: 0.95 | top_k: 40 | max_tokens: 2048<br>
      Wrapped in <code>retry_with_exponential_backoff()</code>: 3 retries, 2s initial, 30s max delay</div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <div class="node node-decision" style="border-color:var(--accent-red)">
      <div class="node-label red">POST-GENERATION CHECK</div>
      <div class="node-title">Smart Fallback: "cannot find" in answer?</div>
      <div class="node-detail">If SQL succeeded but LLM still couldn't interpret the data:<br>
      1. Run vector search (if not already done)<br>
      2. Regenerate response using CONTEXTUAL_PROMPT + vector results<br>
      This catches cases where SQL data format confuses the LLM</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 5: QUERY EXPANSION
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="panel-expansion" class="panel">
  <div class="flow">

    <div class="node node-start">
      <div class="node-label blue">INPUT</div>
      <div class="node-title">effective_query + query_type.value (as category)</div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <div class="node node-decision">
      <div class="node-label orange">EXPANSION STRATEGY</div>
      <div class="node-title">Category-Aware vs Word-Count-Based?</div>
      <div class="node-detail"><code>expand_smart_category(query, category=query_type.value)</code></div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>
  </div>

  <div class="info-grid">
    <div class="info-box">
      <h4>Category-Aware Expansion Limits</h4>
      <table class="map-table">
        <tr><th>Category</th><th>Max Expansions</th><th>Reasoning</th></tr>
        <tr><td><code>noisy</code></td><td>1</td><td>Avoid false matches from slang</td></tr>
        <tr><td><code>conversational</code></td><td>5</td><td>Catch all synonym variations</td></tr>
        <tr><td><code>simple</code></td><td>4</td><td>Balanced coverage</td></tr>
        <tr><td><code>complex</code></td><td>2</td><td>Focus on core concepts</td></tr>
        <tr><td><em>unknown/default</em></td><td colspan="2"><em>Falls through to word-count logic &darr;</em></td></tr>
      </table>
    </div>

    <div class="info-box">
      <h4>Word-Count Fallback (<code>expand_smart</code>)</h4>
      <table class="map-table">
        <tr><th>Query Length</th><th>Max Expansions</th><th>Reasoning</th></tr>
        <tr><td>&lt; 8 words</td><td>4</td><td>Short queries need more context</td></tr>
        <tr><td>8&ndash;11 words</td><td>3</td><td>Moderate coverage</td></tr>
        <tr><td>12&ndash;14 words</td><td>2</td><td>Query is already specific</td></tr>
        <tr><td>15+ words</td><td>1</td><td>Minimal &mdash; query is detailed</td></tr>
      </table>
    </div>
  </div>

  <div style="max-width:1200px; margin: 20px auto 0;">
    <div class="info-grid">
      <div class="info-box">
        <h4>Expansion Dictionaries</h4>
        <ul>
          <li><strong>STAT_EXPANSIONS</strong> (16 entries): "points" &rarr; PTS, ppg, scoring, scorer, scores</li>
          <li><strong>TEAM_EXPANSIONS</strong> (16 entries): "lakers" &rarr; Los Angeles Lakers, LAL</li>
          <li><strong>PLAYER_NICKNAMES</strong> (10 entries): "jokic" &rarr; Nikola Jokic, Joker</li>
          <li><strong>QUERY_SYNONYMS</strong> (12 entries): "leader" &rarr; top, best, highest, most</li>
        </ul>
      </div>

      <div class="info-box">
        <h4>Example Expansion</h4>
        <p style="margin-bottom:6px"><strong>Input:</strong> "curry 3-point shooting" (3 words)</p>
        <p style="margin-bottom:6px"><strong>Category:</strong> statistical &rarr; falls to word-count &rarr; &lt;8 words &rarr; max_expansions=4</p>
        <p><strong>Output:</strong> "curry 3-point shooting Stephen Curry Steph Curry 3P% 3PT% three point percentage 3-point shooting"</p>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 6: DATA PIPELINE
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="panel-datapipeline" class="panel">
  <div class="flow">

    <!-- Source documents -->
    <div class="node node-start">
      <div class="node-label blue">SOURCE DOCUMENTS</div>
      <div class="node-title">Raw Input Data</div>
      <div class="node-detail">
        <strong>PDFs</strong>: NBA articles, news, analyses (<code>data/inputs/*.pdf</code>)<br>
        <strong>Excel</strong>: Player/team statistics (<code>data/inputs/*.xlsx</code>)<br>
        <strong>Reddit</strong>: Discussion threads, fan opinions (embedded in PDFs)
      </div>
    </div>

    <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- Branch: Vector vs SQL paths -->
    <div class="branch">

      <!-- Vector indexing path -->
      <div class="branch-path" style="max-width:480px">
        <div class="branch-label context">VECTOR PATH (PDFs + Reddit)</div>

        <div class="node node-process highlight-ctx" style="border-color:var(--accent-purple)">
          <div class="node-label purple">STAGE 1 &mdash; LOAD</div>
          <div class="node-title">Document Loading</div>
          <div class="node-detail">
            <strong>PDF</strong>: OCR via EasyOCR/RapidOCR &rarr; text extraction<br>
            <strong>Reddit</strong>: Split-by-marker parser (username, upvotes, text)<br>
            Excel sheets in <code>EXCLUDED_EXCEL_SHEETS</code> are skipped (SQL-only data)
          </div>
        </div>

        <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

        <div class="node node-process highlight-ctx" style="border-color:var(--accent-purple)">
          <div class="node-label purple">STAGE 2 &mdash; CLEAN</div>
          <div class="node-title">Text Normalization</div>
          <div class="node-detail">
            Remove low-quality documents (char count validation)<br>
            Text normalization &amp; deduplication<br>
            Filter advertisements from Reddit threads
          </div>
        </div>

        <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

        <div class="node node-process highlight-ctx" style="border-color:var(--accent-purple)">
          <div class="node-label purple">STAGE 3 &mdash; CHUNK</div>
          <div class="node-title">Text Splitting</div>
          <div class="node-detail">
            <strong>General</strong>: <code>RecursiveCharacterTextSplitter</code><br>
            1500 chars, 150 overlap<br>
            <strong>Reddit</strong>: <code>RedditThreadChunker</code><br>
            Preserves thread structure (post + top comments)<br>
            NBA official account weighting
          </div>
        </div>

        <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

        <div class="node node-decision" style="max-width:480px; border-color:var(--accent-orange)">
          <div class="node-label orange">STAGE 3.5 &mdash; QUALITY CHECK</div>
          <div class="node-title">Chunk Quality Scoring & Filtering</div>
          <div class="node-detail">
            Each chunk gets quality score (0-1) based on:<br>
            &bull; Character count (too short/long = low score)<br>
            &bull; Text coherence &amp; structure<br>
            &bull; Non-English or garbled text detection<br><br>
            <strong>Filter rule</strong>: Chunks with score &lt; 0.5 are <strong>deleted</strong><br>
            Only high-quality chunks proceed to embedding
          </div>
        </div>

        <div class="arrow">
          <div class="arrow-label yes">score ‚â• 0.5 ‚Üí proceed</div>
          <div class="arrow-line" style="height:10px"></div>
          <div class="arrow-head"></div>
        </div>

        <div class="node node-process highlight-ctx" style="border-color:var(--accent-purple)">
          <div class="node-label purple">STAGE 4 &mdash; EMBED</div>
          <div class="node-title">Mistral Embeddings</div>
          <div class="node-detail">
            <code>EmbeddingService.embed_documents()</code><br>
            1024-dimensional vectors per chunk<br>
            Only high-quality chunks (score ‚â• 0.5) are embedded
          </div>
        </div>

        <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

        <div class="node node-output" style="border-color:var(--accent-purple)">
          <div class="node-label green">STAGE 5 &mdash; INDEX</div>
          <div class="node-title">FAISS Vector Store</div>
          <div class="node-detail">
            <code>data/vector/faiss_index.pkl</code> &mdash; FAISS index<br>
            <code>data/vector/document_store.pkl</code> &mdash; chunk metadata<br>
            Used by <code>VectorStoreRepository.search()</code> at query time
          </div>
        </div>
      </div>

      <!-- SQL path -->
      <div class="branch-path" style="max-width:480px">
        <div class="branch-label stat">SQL PATH (Excel)</div>

        <div class="node node-process highlight-stat" style="border-color:var(--accent-blue)">
          <div class="node-label blue">LOAD &amp; TRANSFORM</div>
          <div class="node-title">Excel &rarr; SQLite</div>
          <div class="node-detail">
            <code>load_excel_to_db.py</code><br>
            Reads Excel sheets via pandas<br>
            Creates normalized tables: <code>players</code>, <code>player_stats</code>
          </div>
        </div>

        <div class="arrow"><div class="arrow-line"></div><div class="arrow-head"></div></div>

        <div class="node node-output" style="border-color:var(--accent-blue)">
          <div class="node-label green">DATABASE</div>
          <div class="node-title">SQLite Database</div>
          <div class="node-detail">
            <code>data/sql/nba_stats.db</code><br>
            Tables: <code>players</code> (name, team, age, etc.)<br>
            &amp; <code>player_stats</code> (pts, reb, ast, fg%, etc.)<br>
            Queried by <code>NBAGSQLTool</code> at runtime
          </div>
        </div>

        <div class="arrow">
          <div class="arrow-line" style="height:40px"></div>
        </div>

        <div class="node node-process" style="border-color:var(--accent-orange); border-style:dashed; max-width:480px">
          <div class="node-label orange">ALSO STORED</div>
          <div class="node-title">Interactions Database</div>
          <div class="node-detail">
            <code>data/sql/interactions.db</code><br>
            Stores user queries, responses, feedback, conversation history<br>
            Used by <code>FeedbackRepository</code>
          </div>
        </div>
      </div>

    </div><!-- end branch -->

    <div class="arrow" style="margin-top:20px"><div class="arrow-line"></div><div class="arrow-head"></div></div>

    <!-- Connection to query pipeline -->
    <div class="node node-process" style="border-color:var(--accent-teal)">
      <div class="node-label teal">QUERY TIME</div>
      <div class="node-title">Data Sources Feed into Query Pipeline</div>
      <div class="node-detail">
        <strong>FAISS index</strong> &rarr; Vector search (CONTEXTUAL/HYBRID queries)<br>
        <strong>SQLite DB</strong> &rarr; SQL queries (STATISTICAL/HYBRID queries)<br>
        <em>See "Full Pipeline" tab for the complete query-time flow</em>
      </div>
    </div>

  </div>

  <!-- Pipeline runner info -->
  <div style="max-width:1200px; margin: 30px auto 0;">
    <div class="info-grid">
      <div class="info-box">
        <h4>Running the Data Pipeline</h4>
        <ul>
          <li><strong>Full rebuild</strong>: <code>poetry run python -m src.pipeline.data_pipeline</code></li>
          <li>Stages: Load &rarr; Clean &rarr; Chunk &rarr; Embed &rarr; Index</li>
          <li>OCR processing takes ~30 min for all PDFs</li>
          <li>To update chunks without re-OCR: filter existing pickled chunks and re-embed</li>
        </ul>
      </div>

      <div class="info-box">
        <h4>Key Configuration</h4>
        <ul>
          <li><code>EXCLUDED_EXCEL_SHEETS</code> in <code>data_loader.py</code> &mdash; prevents double-indexing of SQL data</li>
          <li>Chunk size: 1500 chars, overlap: 150 chars</li>
          <li>Embedding model: Mistral (1024 dimensions)</li>
          <li>Data paths configured in <code>src/core/config.py</code> and <code>.env</code></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 7: ALL MAPPINGS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="panel-mappings" class="panel">

  <h3 style="color:var(--heading); margin-bottom: 16px;">Complete Decision &rarr; Action Mapping</h3>

  <table class="map-table">
    <tr>
      <th>#</th>
      <th>Decision Point</th>
      <th>Condition</th>
      <th>Action / Result</th>
      <th>File : Line</th>
    </tr>
    <tr>
      <td>1</td>
      <td><span class="tag tag-greeting">Greeting</span></td>
      <td><code>_is_greeting()</code> = True</td>
      <td>Return canned response, no RAG/SQL/LLM</td>
      <td><code>chat.py:1027</code></td>
    </tr>
    <tr>
      <td>2</td>
      <td>Follow-up</td>
      <td>conversation_id + <code>_is_followup_query()</code></td>
      <td>LLM rewrites query to self-contained form</td>
      <td><code>chat.py:1068</code></td>
    </tr>
    <tr>
      <td>3</td>
      <td>Opinion</td>
      <td>Subjective adjectives detected</td>
      <td><span class="tag tag-vector">CONTEXTUAL</span> &mdash; vector search</td>
      <td><code>query_classifier.py:415</code></td>
    </tr>
    <tr>
      <td>4</td>
      <td>Biographical</td>
      <td><code>_is_biographical()</code> = True</td>
      <td><span class="tag tag-hybrid">HYBRID</span> &mdash; SQL stats + vector bio</td>
      <td><code>query_classifier.py:438</code></td>
    </tr>
    <tr>
      <td>5</td>
      <td>Definitional</td>
      <td><code>_is_definitional()</code> = True</td>
      <td><span class="tag tag-vector">CONTEXTUAL</span> &mdash; override stat keywords</td>
      <td><code>query_classifier.py:444</code></td>
    </tr>
    <tr>
      <td>6</td>
      <td>Glossary term</td>
      <td><code>_has_glossary_term()</code> + no stat intent</td>
      <td><span class="tag tag-vector">CONTEXTUAL</span> &mdash; glossary lookup</td>
      <td><code>query_classifier.py:457</code></td>
    </tr>
    <tr>
      <td>7</td>
      <td>Hybrid patterns</td>
      <td>Any of ~25 hybrid regex matches</td>
      <td><span class="tag tag-hybrid">HYBRID</span></td>
      <td><code>query_classifier.py:464</code></td>
    </tr>
    <tr>
      <td>8</td>
      <td>Auto-promote</td>
      <td>stat &ge; 2 AND context &ge; 1</td>
      <td><span class="tag tag-hybrid">HYBRID</span> &mdash; safe over-promotion</td>
      <td><code>query_classifier.py:478</code></td>
    </tr>
    <tr>
      <td>9</td>
      <td>Pattern count</td>
      <td>stat > context</td>
      <td><span class="tag tag-sql">STATISTICAL</span></td>
      <td><code>query_classifier.py:486</code></td>
    </tr>
    <tr>
      <td>10</td>
      <td>Pattern count</td>
      <td>context > stat</td>
      <td><span class="tag tag-vector">CONTEXTUAL</span></td>
      <td><code>query_classifier.py:493</code></td>
    </tr>
    <tr>
      <td>11</td>
      <td>Default</td>
      <td>Tie or zero matches</td>
      <td><span class="tag tag-vector">CONTEXTUAL</span> (safe default)</td>
      <td><code>query_classifier.py:501</code></td>
    </tr>
  </table>

  <h3 style="color:var(--heading); margin: 30px 0 16px;">Adaptive K &rarr; Complexity Mapping</h3>

  <p style="color:var(--muted); margin-bottom:12px; font-size:0.9rem">
    The <code>_estimate_question_complexity(query)</code> method scores query complexity (0-6+) by detecting indicator patterns, then maps the score to k values (3/5/7/9) for adaptive retrieval depth.
  </p>

  <table class="map-table">
    <tr><th>Complexity Score</th><th>K Value</th><th>Query Examples</th><th>Scoring Logic</th></tr>
    <tr>
      <td>&le; 1</td><td><strong>k = 3</strong></td>
      <td>"How many games?", "Who scored?", "LeBron stats"</td>
      <td>Short (&lt;5 words), simple patterns ("how many", "who scored"), single entity lookup</td>
    </tr>
    <tr>
      <td>2&ndash;3</td><td><strong>k = 5</strong></td>
      <td>"Top 5 scorers", "Compare LeBron vs Curry", "Average points per game"</td>
      <td>Moderate indicators (+1 each): "top", "compare", "most", "average", commas, "and"</td>
    </tr>
    <tr>
      <td>4&ndash;5</td><td><strong>k = 7</strong></td>
      <td>"Explain offensive strategy", "Why is LeBron effective?", "Analyze playoff performance"</td>
      <td>Complex indicators (+2 each): "explain", "analyze", "impact", "why", "strategy", long queries (&gt;50 chars)</td>
    </tr>
    <tr>
      <td>&ge; 6</td><td><strong>k = 9</strong></td>
      <td>"Analyze defensive strategy strengths and effectiveness of zone vs man-to-man across different eras"</td>
      <td>Multiple complex patterns + multi-part ("and", commas) + very long (&gt;100 chars)</td>
    </tr>
  </table>

  <h3 style="color:var(--heading); margin: 30px 0 16px;">Query Category Classification (for Expansion Strategy)</h3>

  <p style="color:var(--muted); margin-bottom:12px; font-size:0.9rem">
    The <code>_classify_category(query)</code> method classifies query quality to determine expansion aggressiveness (noisy=1, conversational=5, simple=4, complex=2).
  </p>

  <table class="map-table">
    <tr><th>Category</th><th>Max Expansions</th><th>Detection Patterns</th><th>Examples</th></tr>
    <tr>
      <td><strong>noisy</strong></td><td>1</td>
      <td>Slang ("yo", "bruh", "lol"), typos ("wuts", "da"), out-of-scope, SQL injection attempts, excessive punctuation (3+ "?")</td>
      <td>"yo whats da best team lol", "'; DROP TABLE;--"</td>
    </tr>
    <tr>
      <td><strong>conversational</strong></td><td>5</td>
      <td>Pronouns ("his", "that player", "they"), follow-up phrases ("what about", "and"), corrections ("actually", "I meant")</td>
      <td>"What about his assists?", "And blocks?"</td>
    </tr>
    <tr>
      <td><strong>complex</strong></td><td>2</td>
      <td>Synthesis terms ("analyze", "evaluate", "synthesize"), multi-part (commas + "and"), long (&gt;15 words)</td>
      <td>"Analyze patterns in playoff efficiency discussions across multiple eras"</td>
    </tr>
    <tr>
      <td><strong>simple</strong></td><td>4</td>
      <td>Default for clear, well-formed queries with no special markers</td>
      <td>"Who are the top 5 scorers?", "Tell me about the Lakers"</td>
    </tr>
  </table>

  <h3 style="color:var(--heading); margin: 30px 0 16px;">Query Type &rarr; Prompt &rarr; Data Source Mapping</h3>

  <table class="map-table">
    <tr><th>Query Type</th><th>SQL Used?</th><th>Vector Used?</th><th>Prompt Template</th><th>LLM Method</th></tr>
    <tr>
      <td><span class="tag tag-sql">STATISTICAL</span> + SQL OK</td>
      <td>Yes</td><td>No</td>
      <td>SQL_ONLY_PROMPT</td>
      <td><code>generate_response()</code></td>
    </tr>
    <tr>
      <td><span class="tag tag-sql">STATISTICAL</span> + SQL FAIL</td>
      <td>Tried, failed</td><td>Yes (fallback)</td>
      <td>SYSTEM_PROMPT_TEMPLATE</td>
      <td><code>generate_response()</code></td>
    </tr>
    <tr>
      <td><span class="tag tag-hybrid">HYBRID</span> + SQL OK + Vector OK</td>
      <td>Yes</td><td>Yes</td>
      <td>HYBRID_PROMPT</td>
      <td><code>generate_response_hybrid()</code></td>
    </tr>
    <tr>
      <td><span class="tag tag-hybrid">HYBRID</span> + SQL FAIL</td>
      <td>Tried, failed</td><td>Yes</td>
      <td>SYSTEM_PROMPT_TEMPLATE</td>
      <td><code>generate_response()</code></td>
    </tr>
    <tr>
      <td><span class="tag tag-vector">CONTEXTUAL</span></td>
      <td>No</td><td>Yes</td>
      <td>CONTEXTUAL_PROMPT</td>
      <td><code>generate_response()</code></td>
    </tr>
    <tr>
      <td><span class="tag tag-greeting">GREETING</span></td>
      <td>No</td><td>No</td>
      <td>None (dict lookup)</td>
      <td>None (no LLM call)</td>
    </tr>
    <tr>
      <td><span class="tag tag-fallback">Smart Fallback</span></td>
      <td>Yes (succeeded)</td><td>Yes (retry)</td>
      <td>CONTEXTUAL_PROMPT</td>
      <td><code>generate_response()</code> (2nd call)</td>
    </tr>
  </table>

  <h3 style="color:var(--heading); margin: 30px 0 16px;">SQL Result Formatting Mapping</h3>

  <table class="map-table">
    <tr><th>Result Shape</th><th>Detection</th><th>Format</th></tr>
    <tr><td>1 row, 1 column (scalar)</td><td>Key contains "count/avg/sum/max/min"</td><td><code>"COUNT Result: 42"</code></td></tr>
    <tr><td>1 row, multiple columns</td><td>Single record lookup</td><td>Bullet points: <code>"&bull; name: LeBron"</code></td></tr>
    <tr><td>Multiple rows (&le; 20)</td><td>Rankings, comparisons</td><td>Numbered list: <code>"1. name: X, pts: Y"</code></td></tr>
    <tr><td>Multiple rows (&gt; 20)</td><td>Large result set</td><td>Numbered list + <code>"(Showing top 20 of N)"</code></td></tr>
  </table>

</div>

<script>
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

  event.target.classList.add('active');
  document.getElementById('panel-' + name).classList.add('active');
}
</script>

</body>
</html>
